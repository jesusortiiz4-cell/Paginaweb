<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin - CMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div id="app">
      <h2>Admin</h2>
      <div id="status">Comprobando sesión...</div>
      <button id="loginBtn" style="display:none">Iniciar sesión</button>
      <button id="logoutBtn" style="display:none">Cerrar sesión</button>
      <div id="cms-root" style="display:none"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2/dist/auth0-spa-js.production.js"></script>

    <script>
    // --- Configuration (replace with Vercel env vars in deployment) ---
    const AUTH0_DOMAIN = "dev-c81j6a8i02bxmujj.us.auth0.com";
    const AUTH0_CLIENT_ID = "EQbZuhjaOe3pS53iVJdL9cq3pHJHNBej";
    // CLIENT SECRET is intentionally NOT included in browser JS (keep secret on server)
    // --- End config ---

    const status = document.getElementById('status');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    (async () => {
      const auth0 = await createAuth0Client({
        domain: AUTH0_DOMAIN,
        client_id: AUTH0_CLIENT_ID,
        cacheLocation: 'localstorage',
        useRefreshTokens: true
      });

      const isAuthenticated = await auth0.isAuthenticated();

      if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
        try {
          await auth0.handleRedirectCallback();
        } catch (e) {
          console.error(e);
        }
        // Actualizamos la URL después de la redirección
        window.history.replaceState({}, document.title, "/Paginaweb/admin/index.html");
      }

      if (await auth0.isAuthenticated()) {
        const user = await auth0.getUser();
        status.innerText = "Autenticado como " + (user.name || user.email || user.sub);
        logoutBtn.style.display = 'inline-block';
        loginBtn.style.display = 'none';
        // Carga Netlify CMS después de autenticación
        loadNetlifyCMS();
      } else {
        status.innerText = "No autenticado. Necesitas iniciar sesión para acceder al CMS.";
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
      }

      loginBtn.onclick = async () => {
        await auth0.loginWithRedirect({
          redirect_uri: window.location.origin + '/Paginaweb/admin/index.html'
        });
      };
      logoutBtn.onclick = async () => {
        await auth0.logout({
          returnTo: window.location.origin + '/Paginaweb/admin/index.html'
        });
      };
    })();

    function loadNetlifyCMS() {
      const cmsRoot = document.getElementById('cms-root');
      cmsRoot.style.display = 'block';
      const script = document.createElement('script');
      script.src = "https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js";
      script.onload = () => {
        console.log('Netlify CMS loaded');
      };
      document.body.appendChild(script);
    }
    </script>
  </body>
</html>

